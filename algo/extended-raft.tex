\tlatex
 \@x{\makebox[0pt][r]{\scriptsize 1\hspace{1em}}}\moduleLeftDash\@xx{
 {\MODULE} extendedraft}\moduleRightDash\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 2\hspace{1em}}}%
\@y{\@s{0}%
 This is the formal specification for the extended Raft consensus algorithm.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 3\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{\.{<}TODO}: Copyright \ensuremath{Info\.{>}
}}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 4\hspace{1em}}}%
\@y{}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 5\hspace{1em}}}%
\@y{\@s{0}%
 Copyright 2014 \ensuremath{Diego} \ensuremath{Ongaro}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 6\hspace{1em}}}%
\@y{\@s{0}%
 This work is licensed under the Creative Commons
 Attribution\ensuremath{\.{-}4}.0
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 7\hspace{1em}}}%
\@y{\@s{0}%
 International License
 https:\ensuremath{\.{\slsl}creativecommons.org}/licenses/by/4.0/
}%
\@xx{}%
\@pvspace{8.0pt}%
 \@x{\makebox[0pt][r]{\scriptsize 9\hspace{1em}} {\EXTENDS} Naturals ,\,
 FiniteSets ,\, Sequences ,\, TLC}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 11\hspace{1em}}}%
\@y{\@s{0}%
 The set of server \ensuremath{IDs
}}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 12\hspace{1em}} {\CONSTANTS} Server}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 14\hspace{1em}}}%
\@y{\@s{0}%
 The set of requests that can go into the \ensuremath{log
}}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 15\hspace{1em}} {\CONSTANTS} Value}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 17\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{ID} of the witness
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 18\hspace{1em}} {\CONSTANTS} WitnessID}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 20\hspace{1em}}}%
\@y{\@s{0}%
 Server states.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 21\hspace{1em}} {\CONSTANTS} Follower ,\,
 Candidate ,\, Leader}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 23\hspace{1em}}}%
\@y{\@s{0}%
 A reserved value.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 24\hspace{1em}} {\CONSTANTS} Nil}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 26\hspace{1em}}}%
\@y{\@s{0}%
 Message types:
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 27\hspace{1em}} {\CONSTANTS}
 RequestVoteRequest ,\, RequestVoteResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 28\hspace{1em}}\@s{54.75}
 AppendEntriesRequest ,\, AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 29\hspace{1em}}\@s{54.75}
 RequestWitnessVoteRequest ,\, AppendEntriesToWitnessRequest}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 31\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 32\hspace{1em}}}%
\@y{\@s{0}%
 Global variables
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 34\hspace{1em}}}%
\@y{\@s{0}%
 A bag of records representing requests and responses sent from one server
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 35\hspace{1em}}}%
\@y{\@s{0}%
 to another. \ensuremath{TLAPS} doesn\mbox{'}t support the Bags module, so
 this is a function
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 36\hspace{1em}}}%
\@y{\@s{0}%
 mapping Message to \ensuremath{Nat}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 37\hspace{1em}} {\VARIABLE} messages}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 39\hspace{1em}}}%
\@y{\@s{0}%
 A history variable used in the proof. This would not be present in an
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 40\hspace{1em}}}%
\@y{\@s{0}%
 implementation.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 41\hspace{1em}}}%
\@y{\@s{0}%
 Keeps track of successful elections, including the initial logs of the
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 42\hspace{1em}}}%
\@y{\@s{0}%
 leader and voters\mbox{'} logs. Set of functions containing various things
 about
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 43\hspace{1em}}}%
\@y{\@s{0}%
 successful elections (see \ensuremath{BecomeLeader}).
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 44\hspace{1em}} {\VARIABLE} elections}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 46\hspace{1em}}}%
\@y{\@s{0}%
 A history variable used in the proof. This would not be present in an
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 47\hspace{1em}}}%
\@y{\@s{0}%
 implementation.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 48\hspace{1em}}}%
\@y{\@s{0}%
 Keeps track of every \ensuremath{log} ever in the system (set of logs).
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 49\hspace{1em}} {\VARIABLE} allLogs}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 51\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 52\hspace{1em}}}%
\@y{\@s{0}%
 The following variables are all per server (functions with domain
 \ensuremath{Server}).
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 54\hspace{1em}}}%
\@y{\@s{0}%
 The server\mbox{'}s term number.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 55\hspace{1em}} {\VARIABLE} currentTerm}%
\@x{\makebox[0pt][r]{\scriptsize 56\hspace{1em}}}%
\@y{\@s{0}%
 The server\mbox{'}s state (Follower, \ensuremath{Candidate}, or
 \ensuremath{Leader}).
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 57\hspace{1em}} {\VARIABLE} state}%
\@x{\makebox[0pt][r]{\scriptsize 58\hspace{1em}}}%
\@y{\@s{0}%
 The candidate the server voted for in its current term, or
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 59\hspace{1em}}}%
\@y{\@s{0}%
 Nil if it hasn\mbox{'}t voted for any.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 60\hspace{1em}} {\VARIABLE} votedFor}%
 \@x{\makebox[0pt][r]{\scriptsize 61\hspace{1em}} serverVars \.{\defeq}
 {\langle} currentTerm ,\, state ,\, votedFor {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 63\hspace{1em}}}%
\@y{\@s{0}%
 A Sequence of \ensuremath{log} entries. The index into this sequence is the
 index of the
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 64\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{log} entry. Unfortunately, the Sequence module defines
 \ensuremath{Head(s)} as the entry
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 65\hspace{1em}}}%
\@y{\@s{0}%
 with index 1, so be careful not to use that!
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 66\hspace{1em}} {\VARIABLE} log}%
\@x{\makebox[0pt][r]{\scriptsize 67\hspace{1em}}}%
\@y{\@s{0}%
 The index of the latest entry in the \ensuremath{log} the state machine may
 apply.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 68\hspace{1em}} {\VARIABLE} commitIndex}%
 \@x{\makebox[0pt][r]{\scriptsize 69\hspace{1em}} logVars \.{\defeq} {\langle}
 log ,\, commitIndex {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 71\hspace{1em}}}%
\@y{\@s{0}%
 The following variables are used only on candidates:
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 72\hspace{1em}}}%
\@y{\@s{0}%
 The set of servers from which the candidate has received a
 \ensuremath{RequestVote
}}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 73\hspace{1em}}}%
\@y{\@s{0}%
 response in its \ensuremath{currentTerm}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 74\hspace{1em}} {\VARIABLE} votesResponded}%
\@x{\makebox[0pt][r]{\scriptsize 75\hspace{1em}}}%
\@y{\@s{0}%
 The set of servers from which the candidate has received a vote in its
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 76\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{currentTerm}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 77\hspace{1em}} {\VARIABLE} votesGranted}%
\@x{\makebox[0pt][r]{\scriptsize 78\hspace{1em}}}%
\@y{\@s{0}%
 A history variable used in the proof. This would not be present in an
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 79\hspace{1em}}}%
\@y{\@s{0}%
 implementation.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 80\hspace{1em}}}%
\@y{\@s{0}%
 Function from each server that voted for this candidate in its
 \ensuremath{currentTerm
}}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 81\hspace{1em}}}%
\@y{\@s{0}%
 to that voter\mbox{'}s \ensuremath{log}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 82\hspace{1em}} {\VARIABLE} voterLog}%
 \@x{\makebox[0pt][r]{\scriptsize 83\hspace{1em}} candidateVars \.{\defeq}
 {\langle} votesResponded ,\, votesGranted ,\, voterLog {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 85\hspace{1em}}}%
\@y{\@s{0}%
 The following variables are used only on leaders:
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 86\hspace{1em}}}%
\@y{\@s{0}%
 The next entry to send to each follower.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 87\hspace{1em}} {\VARIABLE} nextIndex}%
\@x{\makebox[0pt][r]{\scriptsize 88\hspace{1em}}}%
\@y{\@s{0}%
 The latest entry that each follower has acknowledged is the same as the
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 89\hspace{1em}}}%
\@y{\@s{0}%
 leader\mbox{'}s. This is used to calculate \ensuremath{commitIndex} on the
 leader.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 90\hspace{1em}} {\VARIABLE} matchIndex}%
\@x{\makebox[0pt][r]{\scriptsize 91\hspace{1em}}}%
\@y{\@s{0}%
 Leader\mbox{'}s replication set
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 92\hspace{1em}} {\VARIABLE} replicationSet}%
\@x{\makebox[0pt][r]{\scriptsize 93\hspace{1em}}}%
\@y{\@s{0}%
 Leader\mbox{'}s \ensuremath{subterm} number
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 94\hspace{1em}} {\VARIABLE} currentSubterm}%
\@x{\makebox[0pt][r]{\scriptsize 95\hspace{1em}}}%
\@y{\@s{0}%
 The latest \ensuremath{subterm} that this leader has written to the witness
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 96\hspace{1em}} {\VARIABLE} witnessSubterm}%
 \@x{\makebox[0pt][r]{\scriptsize 97\hspace{1em}} leaderVars \.{\defeq}
 {\langle} nextIndex ,\, matchIndex ,\, elections ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 98\hspace{1em}}\@s{69.36} replicationSet ,\,
 currentSubterm ,\, witnessSubterm {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 100\hspace{1em}}}%
\@y{\@s{0}%
 The following variables are persisted only on witness:
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 101\hspace{1em}}}%
\@y{\@s{0}%
 The latest replication set sent from leader
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 102\hspace{1em}} {\VARIABLE}
 witnessReplicationSet}%
\@x{\makebox[0pt][r]{\scriptsize 103\hspace{1em}}}%
\@y{\@s{0}%
 The latest term of replicated \ensuremath{log} entry
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 104\hspace{1em}} {\VARIABLE}
 witnessLastLogTerm}%
\@x{\makebox[0pt][r]{\scriptsize 105\hspace{1em}}}%
\@y{\@s{0}%
 The latest \ensuremath{subterm} of replicated \ensuremath{log} entry
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 106\hspace{1em}} {\VARIABLE}
 witnessLastLogSubterm}%
 \@x{\makebox[0pt][r]{\scriptsize 107\hspace{1em}} witnessVars \.{\defeq}
 {\langle} witnessReplicationSet ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 108\hspace{1em}}\@s{75.11}
 witnessLastLogTerm ,\, witnessLastLogSubterm {\rangle}}%
\@pvspace{16.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 111\hspace{1em}}}%
\@y{\@s{0}%
 End of per server variables.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 112\hspace{1em}}}\midbar\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 114\hspace{1em}}}%
\@y{\@s{0}%
 All variables; used for stuttering (asserting state hasn\mbox{'}t changed).
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 115\hspace{1em}} vars \.{\defeq} {\langle}
 messages ,\, allLogs ,\, serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 117\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 118\hspace{1em}}}%
\@y{\@s{0}%
 Helpers
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 120\hspace{1em}}}%
\@y{\@s{0}%
 The set of all quorums. This just calculates simple majorities, but the only
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 121\hspace{1em}}}%
\@y{\@s{0}%
 important property is that every quorum overlaps with every other.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 122\hspace{1em}} Quorum \.{\defeq} \{ i
 \.{\in} {\SUBSET} ( Server ) \.{:} Cardinality ( i ) \.{*} 2 \.{>}
 Cardinality ( Server ) \}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 124\hspace{1em}}}%
\@y{\@s{0}%
 The term of the last entry in a \ensuremath{log}, or 0 if the
 \ensuremath{log} is empty.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 125\hspace{1em}} LastTerm ( xlog )
 \.{\defeq} {\IF} Len ( xlog ) \.{=} 0 \.{\THEN} 0 \.{\ELSE} xlog [ Len (
 xlog ) ] . term}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 127\hspace{1em}}}%
\@y{\@s{0}%
 The \ensuremath{subterm} of the last entry in a \ensuremath{log}, or 0 if
 the \ensuremath{log} is empty.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 128\hspace{1em}} LastSubTerm ( xlog )
 \.{\defeq} {\IF} Len ( xlog ) \.{=} 0 \.{\THEN} 0 \.{\ELSE} xlog [ Len (
 xlog ) ] . subterm}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 130\hspace{1em}}}%
\@y{\@s{0}%
 Helper for \ensuremath{Send} and \ensuremath{Reply}. Given a message
 \ensuremath{m} and bag of messages, return a
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 131\hspace{1em}}}%
\@y{\@s{0}%
 new bag of messages with one more \ensuremath{m} in it.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 132\hspace{1em}} WithMessage ( m ,\, msgs )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 133\hspace{1em}}\@s{16.4} {\IF} m \.{\in}
 {\DOMAIN} msgs \.{\THEN}}%
 \@x{\makebox[0pt][r]{\scriptsize 134\hspace{1em}}\@s{32.65} [ msgs {\EXCEPT}
 {\bang} [ m ] \.{=} msgs [ m ] \.{+} 1 ]}%
\@x{\makebox[0pt][r]{\scriptsize 135\hspace{1em}}\@s{16.4} \.{\ELSE}}%
 \@x{\makebox[0pt][r]{\scriptsize 136\hspace{1em}}\@s{32.8} msgs \.{\,@@\,} (
 m \.{\colongt} 1 )}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 138\hspace{1em}}}%
\@y{\@s{0}%
 Helper for \ensuremath{Discard} and \ensuremath{Reply}. Given a message
 \ensuremath{m} and bag of messages, return
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 139\hspace{1em}}}%
\@y{\@s{0}%
 a new bag of messages with one less \ensuremath{m} in it.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 140\hspace{1em}} WithoutMessage ( m ,\, msgs
 ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 141\hspace{1em}}\@s{16.4} {\IF} m \.{\in}
 {\DOMAIN} msgs \.{\THEN}}%
 \@x{\makebox[0pt][r]{\scriptsize 142\hspace{1em}}\@s{32.65} [ msgs {\EXCEPT}
 {\bang} [ m ] \.{=} msgs [ m ] \.{-} 1 ]}%
\@x{\makebox[0pt][r]{\scriptsize 143\hspace{1em}}\@s{16.4} \.{\ELSE}}%
\@x{\makebox[0pt][r]{\scriptsize 144\hspace{1em}}\@s{32.8} msgs}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 146\hspace{1em}}}%
\@y{\@s{0}%
 Add a message to the bag of messages.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 147\hspace{1em}} Send ( m ) \.{\defeq}
 messages \.{'} \.{=} WithMessage ( m ,\, messages )}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 149\hspace{1em}}}%
\@y{\@s{0}%
 Remove a message from the bag of messages. Used when a server is done
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 150\hspace{1em}}}%
\@y{\@s{0}%
 processing a message.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 151\hspace{1em}} Discard ( m ) \.{\defeq}
 messages \.{'} \.{=} WithoutMessage ( m ,\, messages )}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 153\hspace{1em}}}%
\@y{\@s{0}%
 Combination of \ensuremath{Send} and \ensuremath{Discard
}}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 154\hspace{1em}} Reply ( response ,\,
 request ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 155\hspace{1em}}\@s{16.4} messages \.{'}
 \.{=} WithoutMessage ( request ,\, WithMessage ( response ,\, messages ) )}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 157\hspace{1em}}}%
\@y{\@s{0}%
 Return the minimum value from a set, or undefined if the set is empty.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 158\hspace{1em}} Min ( s ) \.{\defeq}
 {\CHOOSE} x \.{\in} s \.{:} \A\, y \.{\in} s \.{:} x \.{\leq} y}%
\@x{\makebox[0pt][r]{\scriptsize 159\hspace{1em}}}%
\@y{\@s{0}%
 Return the maximum value from a set, or undefined if the set is empty.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 160\hspace{1em}} Max ( s ) \.{\defeq}
 {\CHOOSE} x \.{\in} s \.{:} \A\, y \.{\in} s \.{:} x \.{\geq} y}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 162\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 163\hspace{1em}}}%
\@y{\@s{0}%
 Define initial values for all variables
}%
\@xx{}%
\@pvspace{8.0pt}%
 \@x{\makebox[0pt][r]{\scriptsize 165\hspace{1em}} InitHistoryVars \.{\defeq}
 \.{\land} elections \.{=} \{ \}}%
 \@x{\makebox[0pt][r]{\scriptsize 166\hspace{1em}}\@s{87.75} \.{\land}
 allLogs\@s{11.19} \.{=} \{ \}}%
 \@x{\makebox[0pt][r]{\scriptsize 167\hspace{1em}}\@s{87.75} \.{\land}
 voterLog\@s{0.18} \.{=} [ i \.{\in} Server \.{\mapsto} [ j \.{\in} \{ \}
 \.{\mapsto} {\langle} {\rangle} ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 168\hspace{1em}} InitServerVars \.{\defeq}
 \.{\land} currentTerm \.{=} [ i \.{\in} Server \.{\mapsto} 1 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 169\hspace{1em}}\@s{83.51} \.{\land}
 state\@s{34.38} \.{=} [ i \.{\in} Server \.{\mapsto} Follower ]}%
 \@x{\makebox[0pt][r]{\scriptsize 170\hspace{1em}}\@s{83.51} \.{\land}
 votedFor\@s{17.18} \.{=} [ i \.{\in} Server \.{\mapsto} Nil ]}%
 \@x{\makebox[0pt][r]{\scriptsize 171\hspace{1em}} InitCandidateVars
 \.{\defeq} \.{\land} votesResponded \.{=} [ i \.{\in} Server \.{\mapsto} \{
 \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 172\hspace{1em}}\@s{99.87} \.{\land}
 votesGranted\@s{10.41} \.{=} [ i \.{\in} Server \.{\mapsto} \{ \} ]}%
\@x{\makebox[0pt][r]{\scriptsize 173\hspace{1em}}}%
\@y{\@s{0}%
 The values \ensuremath{nextIndex[i][i]} and \ensuremath{matchIndex[i][i]}
 are never read, since the
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 174\hspace{1em}}}%
\@y{\@s{0}%
 leader does not send itself messages. It\mbox{'}s still easier to include
 these
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 175\hspace{1em}}}%
\@y{\@s{0}%
 in the functions.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 176\hspace{1em}} InitLeaderVars \.{\defeq}
 \.{\land} nextIndex\@s{8.13} \.{=} [ i \.{\in} Server \.{\mapsto} [ j
 \.{\in} Server \.{\mapsto} 1 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 177\hspace{1em}}\@s{84.54} \.{\land}
 matchIndex \.{=} [ i \.{\in} Server \.{\mapsto} [ j \.{\in} Server
 \.{\mapsto} 0 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 178\hspace{1em}}\@s{84.54} \.{\land}
 replicationSet\@s{8.25} \.{=} Server \.{\,\backslash\,} \{ WitnessID \}}%
 \@x{\makebox[0pt][r]{\scriptsize 179\hspace{1em}}\@s{84.54} \.{\land}
 currentSubterm \.{=} 0}%
 \@x{\makebox[0pt][r]{\scriptsize 180\hspace{1em}} InitLogVars \.{\defeq}
 \.{\land} log\@s{48.43} \.{=} [ i\@s{0.76} \.{\in} Server \.{\mapsto}
 {\langle} {\rangle} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 181\hspace{1em}}\@s{70.62} \.{\land}
 commitIndex\@s{4.10} \.{=} [ i\@s{0.76} \.{\in} Server \.{\mapsto} 0 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 182\hspace{1em}} InitWitnessVars \.{\defeq}
 \.{\land} witnessReplicationSet \.{=} \{ \}}%
 \@x{\makebox[0pt][r]{\scriptsize 183\hspace{1em}}\@s{90.43} \.{\land}
 witnessLastLogTerm \.{=} 0}%
 \@x{\makebox[0pt][r]{\scriptsize 184\hspace{1em}}\@s{90.43} \.{\land}
 witnessLastLogSubterm \.{=} 0}%
 \@x{\makebox[0pt][r]{\scriptsize 185\hspace{1em}} Init \.{\defeq} \.{\land}
 messages \.{=} [ m \.{\in} \{ \} \.{\mapsto} 0 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 186\hspace{1em}}\@s{35.70} \.{\land}
 InitHistoryVars}%
 \@x{\makebox[0pt][r]{\scriptsize 187\hspace{1em}}\@s{35.70} \.{\land}
 InitServerVars}%
 \@x{\makebox[0pt][r]{\scriptsize 188\hspace{1em}}\@s{35.70} \.{\land}
 InitCandidateVars}%
 \@x{\makebox[0pt][r]{\scriptsize 189\hspace{1em}}\@s{35.70} \.{\land}
 InitLeaderVars}%
 \@x{\makebox[0pt][r]{\scriptsize 190\hspace{1em}}\@s{35.70} \.{\land}
 InitLogVars}%
 \@x{\makebox[0pt][r]{\scriptsize 191\hspace{1em}}\@s{35.70} \.{\land}
 InitWitnessVars}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 193\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 194\hspace{1em}}}%
\@y{\@s{0}%
 Define state transitions
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 196\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} restarts from stable storage.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 197\hspace{1em}}}%
\@y{\@s{0}%
 It loses everything but its \ensuremath{currentTerm}, \ensuremath{votedFor},
 and \ensuremath{log}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 198\hspace{1em}} Restart ( i ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 199\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 i\@s{53.3} \.{\neq} WitnessID}%
 \@x{\makebox[0pt][r]{\scriptsize 200\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 state \.{'}\@s{46.90} \.{=} [ state {\EXCEPT} {\bang} [ i ] \.{=} Follower
 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 201\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 votesResponded \.{'}\@s{0.23} \.{=} [ votesResponded {\EXCEPT} {\bang} [ i ]
 \.{=} \{ \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 202\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 votesGranted \.{'}\@s{10.65} \.{=} [ votesGranted {\EXCEPT} {\bang} [ i ]
 \.{=} \{ \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 203\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 voterLog \.{'}\@s{30.41} \.{=} [ voterLog {\EXCEPT} {\bang} [ i ] \.{=} [ j
 \.{\in} \{ \} \.{\mapsto} {\langle} {\rangle} ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 204\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 nextIndex \.{'}\@s{24.89} \.{=} [ nextIndex {\EXCEPT} {\bang} [ i ] \.{=} [
 j \.{\in} Server \.{\mapsto} 1 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 205\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 matchIndex \.{'}\@s{16.75} \.{=} [ matchIndex {\EXCEPT} {\bang} [ i ] \.{=}
 [ j \.{\in} Server \.{\mapsto} 0 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 206\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 commitIndex \.{'}\@s{11.12} \.{=} [ commitIndex {\EXCEPT} {\bang} [ i ]
 \.{=} 0 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 207\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 currentSubterm \.{'} \.{=} [ currentSubterm {\EXCEPT} {\bang} [ i ] \.{=} 0
 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 208\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 replicationSet \.{'}\@s{8.25} \.{=} [ replicationSet {\EXCEPT} {\bang} [ i
 ]\@s{8.25} \.{=} Server ]}%
 \@x{\makebox[0pt][r]{\scriptsize 209\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 witnessSubterm \.{'} \.{=} [ witnessSubterm {\EXCEPT} {\bang} [ i ] \.{=} 0
 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 210\hspace{1em}}\@s{16.4} \.{\land}\@s{4.88}
 {\UNCHANGED} {\langle} messages ,\, currentTerm ,\, votedFor ,\, log ,\,
 elections ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 212\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} times out and starts a new election.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 213\hspace{1em}} Timeout ( i ) \.{\defeq}
 \.{\land} i \.{\neq} WitnessID}%
 \@x{\makebox[0pt][r]{\scriptsize 214\hspace{1em}}\@s{67.98} \.{\land} state [
 i ] \.{\in} \{ Follower ,\, Candidate \}}%
 \@x{\makebox[0pt][r]{\scriptsize 215\hspace{1em}}\@s{67.98} \.{\land} state
 \.{'} \.{=} [ state {\EXCEPT} {\bang} [ i ] \.{=} Candidate ]}%
 \@x{\makebox[0pt][r]{\scriptsize 216\hspace{1em}}\@s{67.98} \.{\land}
 currentTerm \.{'} \.{=} [ currentTerm {\EXCEPT} {\bang} [ i ] \.{=}
 currentTerm [ i ] \.{+} 1 ]}%
\@x{\makebox[0pt][r]{\scriptsize 217\hspace{1em}}\@s{67.98}}%
\@y{\@s{0}%
 Most implementations would probably just set the local vote
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 218\hspace{1em}}\@s{67.98}}%
\@y{\@s{0}%
 atomically, but messaging localhost for it is weaker.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 219\hspace{1em}}\@s{67.98} \.{\land}
 votedFor \.{'} \.{=} [ votedFor {\EXCEPT} {\bang} [ i ] \.{=} Nil ]}%
 \@x{\makebox[0pt][r]{\scriptsize 220\hspace{1em}}\@s{67.98} \.{\land}
 votesResponded \.{'} \.{=} [ votesResponded {\EXCEPT} {\bang} [ i ] \.{=} \{
 \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 221\hspace{1em}}\@s{67.98} \.{\land}
 votesGranted \.{'}\@s{10.41} \.{=} [ votesGranted {\EXCEPT} {\bang} [ i ]
 \.{=} \{ \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 222\hspace{1em}}\@s{67.98} \.{\land}
 voterLog \.{'}\@s{30.17} \.{=} [ voterLog {\EXCEPT} {\bang} [ i ] \.{=} [ j
 \.{\in} \{ \} \.{\mapsto} {\langle} {\rangle} ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 223\hspace{1em}}\@s{67.98} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, leaderVars ,\, logVars ,\, witnessVars
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 225\hspace{1em}}}%
\@y{\@s{0}%
 Candidate \ensuremath{i} sends \ensuremath{j} a \ensuremath{RequestVote}
 request.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 226\hspace{1em}} RequestVote ( i ,\, j )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 227\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Candidate}%
 \@x{\makebox[0pt][r]{\scriptsize 228\hspace{1em}}\@s{16.4} \.{\land} j
 \.{\neq} WitnessID}%
 \@x{\makebox[0pt][r]{\scriptsize 229\hspace{1em}}\@s{16.4} \.{\land} j
 \.{\notin} votesResponded [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 230\hspace{1em}}\@s{16.4} \.{\land} Send ( [
 mtype\@s{36.94} \.{\mapsto} RequestVoteRequest ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 231\hspace{1em}}\@s{56.16} mterm\@s{33.98}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 232\hspace{1em}}\@s{56.16}
 mlastLogTerm\@s{0.88} \.{\mapsto} LastTerm ( log [ i ] ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 233\hspace{1em}}\@s{56.16} mlastLogIndex
 \.{\mapsto} Len ( log [ i ] ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 234\hspace{1em}}\@s{56.16} msource\@s{27.35}
 \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 235\hspace{1em}}\@s{56.16} mdest\@s{36.99}
 \.{\mapsto} j ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 236\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 238\hspace{1em}}}%
\@y{\@s{0}%
 Candidate \ensuremath{i} sends witness a \ensuremath{RequestWitnessVote}
 request.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 239\hspace{1em}} RequestWitnessVote ( i )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 240\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Candidate}%
 \@x{\makebox[0pt][r]{\scriptsize 241\hspace{1em}}\@s{16.4} \.{\land}
 WitnessID \.{\notin} votesResponded [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 242\hspace{1em}}\@s{16.4} \.{\land} (
 votesGranted [ i ] \.{\cup} \{ WitnessID \} ) \.{\in} Quorum}%
 \@x{\makebox[0pt][r]{\scriptsize 243\hspace{1em}}\@s{16.4} \.{\land} Send ( [
 mtype\@s{60.88} \.{\mapsto} RequestWitnessVoteRequest ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 244\hspace{1em}}\@s{56.16} mterm\@s{57.92}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 245\hspace{1em}}\@s{56.16}
 mlastLogTerm\@s{24.82} \.{\mapsto} LastTerm ( log [ i ] ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 246\hspace{1em}}\@s{56.16}
 mlastLogSubterm\@s{12.29} \.{\mapsto} LastSubterm ( log [ i ] ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 247\hspace{1em}}\@s{56.16}
 mvotesGranted\@s{21.55} \.{\mapsto} votesGranted [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 248\hspace{1em}}\@s{56.16} msource\@s{51.29}
 \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 249\hspace{1em}}\@s{56.16} mdest\@s{60.94}
 \.{\mapsto} WitnessID ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 250\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 251\hspace{1em}}\@s{89.98} witnessVars
 {\rangle}}%
\@pvspace{16.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 254\hspace{1em}}}%
\@y{\@s{0}%
 Leader \ensuremath{i} sends \ensuremath{j} an \ensuremath{AppendEntries}
 request containing up to 1 entry.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 255\hspace{1em}}}%
\@y{\@s{0}%
 While implementations may want to send more than 1 at a time, this spec uses
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 256\hspace{1em}}}%
\@y{\@s{0}%
 just 1 because it minimizes atomic regions without loss of generality.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 257\hspace{1em}} AppendEntries ( i ,\, j )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 258\hspace{1em}}\@s{16.4} \.{\land} i
 \.{\neq} j}%
 \@x{\makebox[0pt][r]{\scriptsize 259\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Leader}%
 \@x{\makebox[0pt][r]{\scriptsize 260\hspace{1em}}\@s{16.4} \.{\land} \.{\LET}
 prevLogIndex \.{\defeq} nextIndex [ i ] [ j ] \.{-} 1}%
 \@x{\makebox[0pt][r]{\scriptsize 261\hspace{1em}}\@s{47.91} prevLogTerm
 \.{\defeq} {\IF} prevLogIndex \.{>} 0 \.{\THEN}}%
 \@x{\makebox[0pt][r]{\scriptsize 262\hspace{1em}}\@s{140.18} log [ i ] [
 prevLogIndex ] . term}%
\@x{\makebox[0pt][r]{\scriptsize 263\hspace{1em}}\@s{123.92} \.{\ELSE}}%
\@x{\makebox[0pt][r]{\scriptsize 264\hspace{1em}}\@s{140.32} 0}%
\@x{\makebox[0pt][r]{\scriptsize 265\hspace{1em}}\@s{47.91}}%
\@y{\@s{0}%
 Send up to 1 entry, constrained by the end of the \ensuremath{log}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 266\hspace{1em}}\@s{47.91} lastEntry
 \.{\defeq} Min ( \{ Len ( log [ i ] ) ,\, nextIndex [ i ] [ j ] \} )}%
 \@x{\makebox[0pt][r]{\scriptsize 267\hspace{1em}}\@s{47.91} entries
 \.{\defeq} SubSeq ( log [ i ] ,\, nextIndex [ i ] [ j ] ,\, lastEntry )}%
 \@x{\makebox[0pt][r]{\scriptsize 268\hspace{1em}}\@s{27.51} \.{\IN} Send ( [
 mtype\@s{43.98} \.{\mapsto} AppendEntriesRequest ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 269\hspace{1em}}\@s{76.56} mterm\@s{41.02}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 270\hspace{1em}}\@s{76.56}
 mprevLogIndex\@s{4.10} \.{\mapsto} prevLogIndex ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 271\hspace{1em}}\@s{76.56}
 mprevLogTerm\@s{8.2} \.{\mapsto} prevLogTerm ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 272\hspace{1em}}\@s{76.56}
 mentries\@s{31.77} \.{\mapsto} entries ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 273\hspace{1em}}\@s{76.56}}%
\@y{\@s{0}%
 \ensuremath{mlog} is used as a history variable for the proof.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 274\hspace{1em}}\@s{76.56}}%
\@y{\@s{0}%
 It would not exist in a real implementation.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 275\hspace{1em}}\@s{76.56} mlog\@s{52.53}
 \.{\mapsto} log [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 276\hspace{1em}}\@s{76.56}
 mcommitIndex\@s{8.2} \.{\mapsto} Min ( \{ commitIndex [ i ] ,\, lastEntry \}
 ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 277\hspace{1em}}\@s{76.56} msource\@s{37.46}
 \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 278\hspace{1em}}\@s{76.56} mdest\@s{47.10}
 \.{\mapsto} j ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 279\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 280\hspace{1em}}\@s{89.98} witnessVars
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 282\hspace{1em}}}%
\@y{\@s{0}%
 Leader \ensuremath{i} sends witness an \ensuremath{AppendEntriesToWitness}
 request with \ensuremath{log} entry
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 283\hspace{1em}}}%
\@y{\@s{0}%
 in current \ensuremath{subterm} acknowledged by a subquorum in current
 replication set.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 284\hspace{1em}} AppendEntriesToWitness ( i
 ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 285\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Leader}%
 \@x{\makebox[0pt][r]{\scriptsize 286\hspace{1em}}\@s{16.4} \.{\land}
 WitnessID \.{\in} replicationSet [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 287\hspace{1em}}\@s{16.4} \.{\land} \.{\LET}
 Agree ( index ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 288\hspace{1em}}\@s{64.31} \{ i \} \.{\cup}
 \{ k \.{\in} replicationSet [ i ] \.{:} matchIndex [ i ] [ k ] \.{\geq}
 index \}}%
 \@x{\makebox[0pt][r]{\scriptsize 289\hspace{1em}}\@s{47.91} IsAgreed ( k
 )\@s{4.1} \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 290\hspace{1em}}\@s{64.31} \.{\land} log [ i
 ] [ k ] . term\@s{14.05} \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 291\hspace{1em}}\@s{64.31} \.{\land} log [ i
 ] [ k ] . subterm \.{=} currentSubterm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 292\hspace{1em}}\@s{64.31} \.{\land} ( \{
 WitnessID \} \.{\cup} Agree ( k ) ) \.{\in} Quorum}%
 \@x{\makebox[0pt][r]{\scriptsize 293\hspace{1em}}\@s{47.91} agreeIndexes
 \.{\defeq} \{ k \.{\in} 1 \.{\dotdot} Len ( log [ i ] ) \.{:} IsAgreed ( k )
 \}}%
 \@x{\makebox[0pt][r]{\scriptsize 294\hspace{1em}}\@s{47.91}
 lastEntry\@s{14.68} \.{\defeq} Max ( agreedIndex )}%
 \@x{\makebox[0pt][r]{\scriptsize 295\hspace{1em}}\@s{27.51} \.{\IN} \.{\land}
 agreeIndexes \.{\neq} \{ \}}%
 \@x{\makebox[0pt][r]{\scriptsize 296\hspace{1em}}\@s{47.91} \.{\land}
 \.{\lor}}%
\@y{\@s{0}%
 \ensuremath{witnessSubterm} never exceeds \ensuremath{currentSubterm}
 following specification
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 297\hspace{1em}}\@s{70.13} \.{\land}
 currentSubterm [ i ] \.{>} witnessSubterm}%
 \@x{\makebox[0pt][r]{\scriptsize 298\hspace{1em}}\@s{70.13} \.{\land} Send (
 [ mtype\@s{41.72} \.{\mapsto} AppendEntriesToWitnessRequest ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 299\hspace{1em}}\@s{109.89} mterm\@s{38.77}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 300\hspace{1em}}\@s{109.89}
 mlogTerm\@s{23.94} \.{\mapsto} log [ i ] [ lastEntry ] . term ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 301\hspace{1em}}\@s{109.89}
 mlogSubterm\@s{11.42} \.{\mapsto} log [ i ] [ lastEntry ] . subterm ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 302\hspace{1em}}\@s{109.89} mreplicationSet
 \.{\mapsto} replicaitonSet [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 303\hspace{1em}}\@s{109.89} mindex\@s{35.61}
 \.{\mapsto} lastEntry ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 304\hspace{1em}}\@s{109.89}}%
\@y{\@s{0}%
 \ensuremath{mlog} and \ensuremath{mentries} are used as history variable for
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 305\hspace{1em}}\@s{109.89}}%
\@y{\@s{0}%
 the proof. They do not exist in a real implementation.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 306\hspace{1em}}\@s{109.89} mlog\@s{46.39}
 \.{\mapsto} log [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 307\hspace{1em}}\@s{109.89}
 mentries\@s{28.7} \.{\mapsto} SubSeq ( log [ i ] ,\, 1 ,\, lastEntry ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 308\hspace{1em}}\@s{109.89} msource\@s{32.8}
 \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 309\hspace{1em}}\@s{109.89} mdest\@s{40.96}
 \.{\mapsto} WitnessID ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 310\hspace{1em}}\@s{70.13} \.{\land}
 {\UNCHANGED} {\langle} leaderVars {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 311\hspace{1em}}\@s{59.02} \.{\lor}}%
\@y{\@s{0}%
 shortcut replication
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 312\hspace{1em}}\@s{70.13} \.{\land}
 currentSubterm [ i ] \.{=} witnessSubterm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 313\hspace{1em}}\@s{70.13} \.{\land} Send (
 [ mtype\@s{49.62} \.{\mapsto} AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 314\hspace{1em}}\@s{109.89} mterm\@s{46.67}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 315\hspace{1em}}\@s{109.89}
 msuccess\@s{36.52} \.{\mapsto} {\TRUE} ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 316\hspace{1em}}\@s{109.89}
 mmatchIndex\@s{16.4} \.{\mapsto} lastEntry ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 317\hspace{1em}}\@s{109.89}
 msource\@s{40.04} \.{\mapsto} WitnessID ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 318\hspace{1em}}\@s{109.89} mdest\@s{49.68}
 \.{\mapsto} i ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 319\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, logVars ,\,
 witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 321\hspace{1em}}}%
\@y{\@s{0}%
 Candidate \ensuremath{i} transitions to leader.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 322\hspace{1em}} BecomeLeader ( i )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 323\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Candidate}%
 \@x{\makebox[0pt][r]{\scriptsize 324\hspace{1em}}\@s{16.4} \.{\land}
 votesGranted [ i ] \.{\in} Quorum}%
 \@x{\makebox[0pt][r]{\scriptsize 325\hspace{1em}}\@s{16.4} \.{\land} state
 \.{'}\@s{30.15} \.{=} [ state {\EXCEPT} {\bang} [ i ] \.{=} Leader ]}%
 \@x{\makebox[0pt][r]{\scriptsize 326\hspace{1em}}\@s{16.4} \.{\land}
 nextIndex \.{'}\@s{8.13} \.{=} [ nextIndex {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 327\hspace{1em}}\@s{110.08} [ j \.{\in}
 Server \.{\mapsto} Len ( log [ i ] ) \.{+} 1 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 328\hspace{1em}}\@s{16.4} \.{\land}
 matchIndex \.{'} \.{=} [ matchIndex {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 329\hspace{1em}}\@s{110.08} [ j \.{\in}
 Server \.{\mapsto} 0 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 330\hspace{1em}}\@s{16.4} \.{\land}
 elections \.{'}\@s{13.47} \.{=} elections \.{\cup}}%
 \@x{\makebox[0pt][r]{\scriptsize 331\hspace{1em}}\@s{111.40} \{ [
 eterm\@s{16.61} \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 332\hspace{1em}}\@s{119.18}
 eleader\@s{10.93} \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 333\hspace{1em}}\@s{119.18} elog\@s{25.05}
 \.{\mapsto} log [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 334\hspace{1em}}\@s{119.18} evotes\@s{15.15}
 \.{\mapsto} votesGranted [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 335\hspace{1em}}\@s{119.18} evoterLog
 \.{\mapsto} voterLog [ i ] ] \}}%
 \@x{\makebox[0pt][r]{\scriptsize 336\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, currentTerm ,\, votedFor ,\,
 candidateVars ,\, logVars ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 338\hspace{1em}}}%
\@y{\@s{0}%
 Leader \ensuremath{i} receives a client request to add \ensuremath{v} to the
 \ensuremath{log}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 339\hspace{1em}} ClientRequest ( i ,\, v )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 340\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Leader}%
 \@x{\makebox[0pt][r]{\scriptsize 341\hspace{1em}}\@s{16.4} \.{\land} \.{\LET}
 entry\@s{13.31} \.{\defeq} [ term\@s{26.35} \.{\mapsto} currentTerm [ i ]
 ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 342\hspace{1em}}\@s{106.38}
 subterm\@s{12.30} \.{\mapsto} currentSubterm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 343\hspace{1em}}\@s{106.38} value\@s{24.45}
 \.{\mapsto} v ]}%
 \@x{\makebox[0pt][r]{\scriptsize 344\hspace{1em}}\@s{52.01} newLog \.{\defeq}
 Append ( log [ i ] ,\, entry )}%
 \@x{\makebox[0pt][r]{\scriptsize 345\hspace{1em}}\@s{31.61} \.{\IN} log \.{'}
 \.{=} [ log {\EXCEPT} {\bang} [ i ] \.{=} newLog ]}%
 \@x{\makebox[0pt][r]{\scriptsize 346\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, serverVars ,\, candidateVars ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 347\hspace{1em}}\@s{89.98} leaderVars ,\,
 commitIndex ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 349\hspace{1em}}}%
\@y{\@s{0}%
 Leader \ensuremath{i} advances its \ensuremath{commitIndex}.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 350\hspace{1em}}}%
\@y{\@s{0}%
 This is done as a separate step from handling \ensuremath{AppendEntries}
 responses,
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 351\hspace{1em}}}%
\@y{\@s{0}%
 in part to minimize atomic regions, and in part so that leaders of
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 352\hspace{1em}}}%
\@y{\@s{0}%
 single-server clusters are able to mark entries committed.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 353\hspace{1em}} AdvanceCommitIndex ( i )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 354\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Leader}%
 \@x{\makebox[0pt][r]{\scriptsize 355\hspace{1em}}\@s{16.4} \.{\land}
 \.{\LET}}%
\@y{\@s{0}%
 The set of servers that agree up through index.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 356\hspace{1em}}\@s{47.91} Agree ( index )
 \.{\defeq} \{ i \} \.{\cup} \{ k \.{\in} Server \.{:}}%
 \@x{\makebox[0pt][r]{\scriptsize 357\hspace{1em}}\@s{167.56} matchIndex [ i ]
 [ k ] \.{\geq} index \}}%
\@x{\makebox[0pt][r]{\scriptsize 358\hspace{1em}}\@s{47.91}}%
\@y{\@s{0}%
 The maximum indexes for which a quorum agrees
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 359\hspace{1em}}\@s{47.91} agreeIndexes
 \.{\defeq} \{ index \.{\in} 1 \.{\dotdot} Len ( log [ i ] ) \.{:}}%
 \@x{\makebox[0pt][r]{\scriptsize 360\hspace{1em}}\@s{143.64} Agree ( index )
 \.{\in} Quorum \}}%
\@x{\makebox[0pt][r]{\scriptsize 361\hspace{1em}}\@s{47.91}}%
\@y{\@s{0}%
 New value for \ensuremath{commitIndex\.{'}[i]
}}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 362\hspace{1em}}\@s{47.91} newCommitIndex
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 363\hspace{1em}}\@s{60.21} {\IF} \.{\land}
 agreeIndexes \.{\neq} \{ \}}%
 \@x{\makebox[0pt][r]{\scriptsize 364\hspace{1em}}\@s{72.36} \.{\land} log [ i
 ] [ Max ( agreeIndexes ) ] . term \.{=} currentTerm [ i ]}%
\@x{\makebox[0pt][r]{\scriptsize 365\hspace{1em}}\@s{60.21} \.{\THEN}}%
 \@x{\makebox[0pt][r]{\scriptsize 366\hspace{1em}}\@s{76.61} Max (
 agreeIndexes )}%
\@x{\makebox[0pt][r]{\scriptsize 367\hspace{1em}}\@s{60.21} \.{\ELSE}}%
 \@x{\makebox[0pt][r]{\scriptsize 368\hspace{1em}}\@s{76.61} commitIndex [ i
 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 369\hspace{1em}}\@s{27.51} \.{\IN}
 commitIndex \.{'} \.{=} [ commitIndex {\EXCEPT} {\bang} [ i ] \.{=}
 newCommitIndex ]}%
 \@x{\makebox[0pt][r]{\scriptsize 370\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, serverVars ,\, candidateVars ,\,
 leaderVars ,\, log ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 372\hspace{1em}}}%
\@y{\@s{0}%
 Adjust replication set on leader \ensuremath{i}. This action updates
 replication set
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 373\hspace{1em}}}%
\@y{\@s{0}%
 by swapping items inside and outside. While implementations may change
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 374\hspace{1em}}}%
\@y{\@s{0}%
 replication set in various ways, the spec uses this simple swapping to
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 375\hspace{1em}}}%
\@y{\@s{0}%
 minimize atomic regions without loss of generality.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 376\hspace{1em}} AdjustReplicationSet ( i )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 377\hspace{1em}}\@s{16.4} \.{\land} state [
 i ] \.{=} Leader}%
 \@x{\makebox[0pt][r]{\scriptsize 378\hspace{1em}}\@s{16.4} \.{\land}
 replicationSet [ i ] \.{\neq} Server}%
\@x{\makebox[0pt][r]{\scriptsize 379\hspace{1em}}\@s{16.4}}%
\@y{\@s{0}%
 Swap server outside replication set with some server inside
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 380\hspace{1em}}\@s{16.4} \.{\land} \.{\LET}
 in\@s{9.39} \.{\defeq} {\CHOOSE} x \.{\in} replicationSet [ i ] \.{:} x
 \.{\neq} i}%
 \@x{\makebox[0pt][r]{\scriptsize 381\hspace{1em}}\@s{52.01} out \.{\defeq}
 {\CHOOSE} x \.{\in} Server \.{\,\backslash\,} replicationSet [ i ] \.{:}
 {\TRUE}}%
 \@x{\makebox[0pt][r]{\scriptsize 382\hspace{1em}}\@s{27.51} \.{\IN}\@s{4.09}
 replicationSet \.{'}\@s{15.50} \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 383\hspace{1em}}\@s{64.31} [ replicationSet
 {\EXCEPT} {\bang} [ i ] \.{=} ( @ \.{\,\backslash\,} \{ in \} ) \.{\cup} \{
 out \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 384\hspace{1em}}\@s{16.4} \.{\land}
 currentSubTerm \.{'} \.{=} [ currentSubTerm {\EXCEPT} {\bang} [ i ] \.{=} @
 \.{+} 1 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 385\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, serverVars ,\, candidateVars ,\,
 nextIndex ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 386\hspace{1em}}\@s{89.98} matchIndex ,\,
 witnessSubterm ,\, log ,\, commitIndex ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 387\hspace{1em}}\@s{89.98} witnessVars
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 389\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 390\hspace{1em}}}%
\@y{\@s{0}%
 Message handlers
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 391\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{i \.{=}} recipient, \ensuremath{j \.{=}} sender, \ensuremath{m
 \.{=}} message
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 393\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} receives a \ensuremath{RequestVote} request from
 server \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 394\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{\leq} currentTerm[i]}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 395\hspace{1em}} HandleRequestVoteRequest (
 i ,\, j ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 396\hspace{1em}}\@s{16.4} \.{\LET} logOk
 \.{\defeq} \.{\lor} m . mlastLogTerm \.{>} LastTerm ( log [ i ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 397\hspace{1em}}\@s{80.78} \.{\lor}
 \.{\land} m . mlastLogTerm \.{=} LastTerm ( log [ i ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 398\hspace{1em}}\@s{91.89} \.{\land} m .
 mlastLogIndex \.{\geq} Len ( log [ i ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 399\hspace{1em}}\@s{36.79} grant\@s{1.78}
 \.{\defeq} \.{\land} m . mterm \.{=} currentTerm [ i ]}%
\@x{\makebox[0pt][r]{\scriptsize 400\hspace{1em}}\@s{80.78} \.{\land} logOk}%
 \@x{\makebox[0pt][r]{\scriptsize 401\hspace{1em}}\@s{80.78} \.{\land}
 votedFor [ i ] \.{\in} \{ Nil ,\, j \}}%
 \@x{\makebox[0pt][r]{\scriptsize 402\hspace{1em}}\@s{16.4} \.{\IN} \.{\land}
 m . mterm \.{\leq} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 403\hspace{1em}}\@s{36.79} \.{\land}
 \.{\lor} grant\@s{6.66} \.{\land} votedFor \.{'} \.{=} [ votedFor {\EXCEPT}
 {\bang} [ i ] \.{=} j ]}%
 \@x{\makebox[0pt][r]{\scriptsize 404\hspace{1em}}\@s{47.91} \.{\lor} {\lnot}
 grant \.{\land} {\UNCHANGED} votedFor}%
 \@x{\makebox[0pt][r]{\scriptsize 405\hspace{1em}}\@s{36.79} \.{\land} Reply (
 [ mtype\@s{35.23} \.{\mapsto} RequestVoteResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 406\hspace{1em}}\@s{79.36} mterm\@s{32.27}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 407\hspace{1em}}\@s{79.36} mvoteGranted
 \.{\mapsto} grant ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 408\hspace{1em}}\@s{79.36}}%
\@y{\@s{0}%
 \ensuremath{mlog} is used just for the \ensuremath{elections} history
 variable for
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 409\hspace{1em}}\@s{79.36}}%
\@y{\@s{0}%
 the proof. It would not exist in a real implementation.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 410\hspace{1em}}\@s{79.36} mlog\@s{35.57}
 \.{\mapsto} log [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 411\hspace{1em}}\@s{79.36} msource\@s{20.5}
 \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 412\hspace{1em}}\@s{79.36} mdest\@s{30.14}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 413\hspace{1em}}\@s{79.36} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 414\hspace{1em}}\@s{36.79} \.{\land}
 {\UNCHANGED} {\langle} state ,\, currentTerm ,\, candidateVars ,\,
 leaderVars ,\, logVars ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 416\hspace{1em}}}%
\@y{\@s{0}%
 Witness receives a \ensuremath{RequestWitnessVote} request from server
 \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 417\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{\leq} currentTerm[WitnessID]}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 418\hspace{1em}}
 HandleRequestWitnessVoteRequest ( j ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 419\hspace{1em}}\@s{16.4} \.{\LET} logOk
 \.{\defeq} \.{\lor} m . mlastLogTerm \.{>} witnessLastLogTerm}%
 \@x{\makebox[0pt][r]{\scriptsize 420\hspace{1em}}\@s{80.78} \.{\lor}
 \.{\land} m . mlastLogTerm \.{=} witnessLastLogTerm}%
 \@x{\makebox[0pt][r]{\scriptsize 421\hspace{1em}}\@s{91.89} \.{\land} m .
 mlastLogSubterm \.{>} witnessLastLogSubterm}%
 \@x{\makebox[0pt][r]{\scriptsize 422\hspace{1em}}\@s{80.78} \.{\lor}
 \.{\land} m . mlastLogTerm \.{=} witnessLastLogTerm}%
 \@x{\makebox[0pt][r]{\scriptsize 423\hspace{1em}}\@s{91.89} \.{\land} m .
 mlastLogSubterm \.{=} witnessLastLogSubterm}%
 \@x{\makebox[0pt][r]{\scriptsize 424\hspace{1em}}\@s{91.89} \.{\land} m .
 mvotesGranted \.{\subseteq} witnessReplicationSet}%
 \@x{\makebox[0pt][r]{\scriptsize 425\hspace{1em}}\@s{36.79} grant\@s{1.78}
 \.{\defeq} \.{\land} m . mterm \.{=} currentTerm [ WitnessID ]}%
\@x{\makebox[0pt][r]{\scriptsize 426\hspace{1em}}\@s{80.78} \.{\land} logOk}%
 \@x{\makebox[0pt][r]{\scriptsize 427\hspace{1em}}\@s{80.78} \.{\land}
 votedFor [ WitnessID ] \.{\in} \{ Nil ,\, j \}}%
 \@x{\makebox[0pt][r]{\scriptsize 428\hspace{1em}}\@s{16.4} \.{\IN} \.{\land}
 m . mterm \.{\leq} currentTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 429\hspace{1em}}\@s{36.79} \.{\land}
 \.{\lor} grant\@s{6.66} \.{\land} votedFor \.{'} \.{=} [ votedFor {\EXCEPT}
 {\bang} [ WitnessID ] \.{=} j ]}%
 \@x{\makebox[0pt][r]{\scriptsize 430\hspace{1em}}\@s{47.91} \.{\lor} {\lnot}
 grant \.{\land} {\UNCHANGED} votedFor}%
 \@x{\makebox[0pt][r]{\scriptsize 431\hspace{1em}}\@s{36.79} \.{\land} Reply (
 [ mtype\@s{35.23} \.{\mapsto} RequestVoteResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 432\hspace{1em}}\@s{79.36} mterm\@s{32.27}
 \.{\mapsto} currentTerm [ WitnessID ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 433\hspace{1em}}\@s{79.36} mvoteGranted
 \.{\mapsto} grant ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 434\hspace{1em}}\@s{79.36}}%
\@y{\@s{0}%
 \ensuremath{mlog} is used just for the \ensuremath{elections} history
 variable for
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 435\hspace{1em}}\@s{79.36}}%
\@y{\@s{0}%
 the proof. It would not exist in a real implementation.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 436\hspace{1em}}\@s{79.36} mlog\@s{35.57}
 \.{\mapsto} log [ WitnessID ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 437\hspace{1em}}\@s{79.36} msource\@s{20.5}
 \.{\mapsto} WitnessID ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 438\hspace{1em}}\@s{79.36} mdest\@s{30.14}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 439\hspace{1em}}\@s{79.36} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 440\hspace{1em}}\@s{36.79} \.{\land}
 {\UNCHANGED} {\langle} state ,\, currentTerm ,\, candidateVars ,\,
 leaderVars ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 441\hspace{1em}}\@s{110.38} logVars ,\,
 witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 443\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} receives a \ensuremath{RequestVote} response from
 server \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 444\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{=} currentTerm[i]}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 445\hspace{1em}} HandleRequestVoteResponse (
 i ,\, j ,\, m ) \.{\defeq}}%
\@x{\makebox[0pt][r]{\scriptsize 446\hspace{1em}}\@s{16.4}}%
\@y{\@s{0}%
 This tallies votes even when the current state is not
 \ensuremath{Candidate}, but
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 447\hspace{1em}}\@s{16.4}}%
\@y{\@s{0}%
 they won\mbox{'}t be looked at, so it doesn\mbox{'}t matter.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 448\hspace{1em}}\@s{16.4} \.{\land} m .
 mterm \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 449\hspace{1em}}\@s{16.4} \.{\land}
 votesResponded \.{'} \.{=} [ votesResponded {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 450\hspace{1em}}\@s{130.69} votesResponded [
 i ] \.{\cup} \{ j \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 451\hspace{1em}}\@s{16.4} \.{\land} \.{\lor}
 \.{\land} m . mvoteGranted}%
 \@x{\makebox[0pt][r]{\scriptsize 452\hspace{1em}}\@s{38.62} \.{\land}
 votesGranted \.{'} \.{=} [ votesGranted {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 453\hspace{1em}}\@s{142.50} votesGranted [ i
 ] \.{\cup} \{ j \} ]}%
 \@x{\makebox[0pt][r]{\scriptsize 454\hspace{1em}}\@s{38.62} \.{\land}
 voterLog \.{'} \.{=} [ voterLog {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 455\hspace{1em}}\@s{122.74} voterLog [ i ]
 \.{\,@@\,} ( j \.{\colongt} m . mlog ) ]}%
 \@x{\makebox[0pt][r]{\scriptsize 456\hspace{1em}}\@s{27.51} \.{\lor}
 \.{\land} {\lnot} m . mvoteGranted}%
 \@x{\makebox[0pt][r]{\scriptsize 457\hspace{1em}}\@s{38.62} \.{\land}
 {\UNCHANGED} {\langle} votesGranted ,\, voterLog {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 458\hspace{1em}}\@s{16.4} \.{\land} Discard
 ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 459\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, votedFor ,\, leaderVars ,\, logVars
 ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 461\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} receives an \ensuremath{AppendEntries} request from
 server \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 462\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{\leq} currentTerm[i]}. This just handles
 \ensuremath{m.entries} of length 0 or 1, but
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 463\hspace{1em}}}%
\@y{\@s{0}%
 implementations could safely accept more by treating them the same as
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 464\hspace{1em}}}%
\@y{\@s{0}%
 multiple independent requests of 1 entry.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 465\hspace{1em}} HandleAppendEntriesRequest
 ( i ,\, j ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 466\hspace{1em}}\@s{16.4} \.{\LET} logOk
 \.{\defeq} \.{\lor} m . mprevLogIndex \.{=} 0}%
 \@x{\makebox[0pt][r]{\scriptsize 467\hspace{1em}}\@s{80.78} \.{\lor}
 \.{\land} m . mprevLogIndex \.{>} 0}%
 \@x{\makebox[0pt][r]{\scriptsize 468\hspace{1em}}\@s{91.89} \.{\land} m .
 mprevLogIndex \.{\leq} Len ( log [ i ] )}%
 \@x{\makebox[0pt][r]{\scriptsize 469\hspace{1em}}\@s{91.89} \.{\land} m .
 mprevLogTerm \.{=} log [ i ] [ m . mprevLogIndex ] . term}%
 \@x{\makebox[0pt][r]{\scriptsize 470\hspace{1em}}\@s{16.4} \.{\IN} \.{\land}
 m . mterm \.{\leq} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 471\hspace{1em}}\@s{36.79} \.{\land}
 \.{\lor} \.{\land}}%
\@y{\@s{0}%
 reject request
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 472\hspace{1em}}\@s{70.13} \.{\lor} m .
 mterm \.{<} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 473\hspace{1em}}\@s{70.13} \.{\lor}
 \.{\land} m . mterm \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 474\hspace{1em}}\@s{81.24} \.{\land} state [
 i ] \.{=} Follower}%
 \@x{\makebox[0pt][r]{\scriptsize 475\hspace{1em}}\@s{81.24} \.{\land} {\lnot}
 logOk}%
 \@x{\makebox[0pt][r]{\scriptsize 476\hspace{1em}}\@s{59.02} \.{\land} Reply (
 [ mtype\@s{49.62} \.{\mapsto} AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 477\hspace{1em}}\@s{101.58} mterm\@s{46.67}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 478\hspace{1em}}\@s{101.58}
 msuccess\@s{36.52} \.{\mapsto} {\FALSE} ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 479\hspace{1em}}\@s{101.58}
 mmatchIndex\@s{16.4} \.{\mapsto} 0 ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 480\hspace{1em}}\@s{101.58}
 msource\@s{40.04} \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 481\hspace{1em}}\@s{101.58} mdest\@s{49.68}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 482\hspace{1em}}\@s{101.58} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 483\hspace{1em}}\@s{59.02} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, logVars {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 484\hspace{1em}}\@s{47.91} \.{\lor}}%
\@y{\@s{0}%
 return to follower state
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 485\hspace{1em}}\@s{59.02} \.{\land} m .
 mterm \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 486\hspace{1em}}\@s{59.02} \.{\land} state [
 i ] \.{=} Candidate}%
 \@x{\makebox[0pt][r]{\scriptsize 487\hspace{1em}}\@s{59.02} \.{\land} state
 \.{'} \.{=} [ state {\EXCEPT} {\bang} [ i ] \.{=} Follower ]}%
 \@x{\makebox[0pt][r]{\scriptsize 488\hspace{1em}}\@s{59.02} \.{\land}
 {\UNCHANGED} {\langle} currentTerm ,\, votedFor ,\, logVars ,\, messages
 {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 489\hspace{1em}}\@s{47.91} \.{\lor}}%
\@y{\@s{0}%
 accept request
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 490\hspace{1em}}\@s{59.02} \.{\land} m .
 mterm \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 491\hspace{1em}}\@s{59.02} \.{\land} state [
 i ] \.{=} Follower}%
\@x{\makebox[0pt][r]{\scriptsize 492\hspace{1em}}\@s{59.02} \.{\land} logOk}%
 \@x{\makebox[0pt][r]{\scriptsize 493\hspace{1em}}\@s{59.02} \.{\land}
 \.{\LET} index \.{\defeq} m . mprevLogIndex \.{+} 1}%
\@x{\makebox[0pt][r]{\scriptsize 494\hspace{1em}}\@s{70.13} \.{\IN} \.{\lor}}%
\@y{\@s{0}%
 already done with request
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 495\hspace{1em}}\@s{105.74} \.{\land}
 \.{\lor} m . mentries \.{=} {\langle} {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 496\hspace{1em}}\@s{116.85} \.{\lor}
 \.{\land} m . mentries \.{\neq} {\langle} {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 497\hspace{1em}}\@s{127.96} \.{\land} Len (
 log [ i ] ) \.{\geq} index}%
 \@x{\makebox[0pt][r]{\scriptsize 498\hspace{1em}}\@s{127.96} \.{\land} log [
 i ] [ index ] . term \.{=} m . mentries [ 1 ] . term}%
\@x{\makebox[0pt][r]{\scriptsize 499\hspace{1em}}\@s{116.85}}%
\@y{\@s{0}%
 This could make our \ensuremath{commitIndex} decrease (for
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 500\hspace{1em}}\@s{116.85}}%
\@y{\@s{0}%
 example if we process an old, duplicated request),
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 501\hspace{1em}}\@s{116.85}}%
\@y{\@s{0}%
 but that doesn\mbox{'}t really affect anything.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 502\hspace{1em}}\@s{105.74} \.{\land}
 commitIndex \.{'} \.{=} [ commitIndex {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 503\hspace{1em}}\@s{209.14} m . mcommitIndex
 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 504\hspace{1em}}\@s{105.74} \.{\land} Reply
 ( [ mtype\@s{49.62} \.{\mapsto} AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 505\hspace{1em}}\@s{148.31} mterm\@s{46.67}
 \.{\mapsto} currentTerm [ i ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 506\hspace{1em}}\@s{148.31}
 msuccess\@s{36.52} \.{\mapsto} {\TRUE} ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 507\hspace{1em}}\@s{148.31}
 mmatchIndex\@s{16.4} \.{\mapsto} m . mprevLogIndex \.{+}}%
 \@x{\makebox[0pt][r]{\scriptsize 508\hspace{1em}}\@s{239.79} Len ( m .
 mentries ) ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 509\hspace{1em}}\@s{148.31}
 msource\@s{40.04} \.{\mapsto} i ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 510\hspace{1em}}\@s{148.31} mdest\@s{49.68}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 511\hspace{1em}}\@s{148.31} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 512\hspace{1em}}\@s{105.74} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, log {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 513\hspace{1em}}\@s{90.53} \.{\lor}}%
\@y{\@s{0}%
 conflict: remove 1 entry
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 514\hspace{1em}}\@s{105.74} \.{\land} m .
 mentries \.{\neq} {\langle} {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 515\hspace{1em}}\@s{105.74} \.{\land} Len (
 log [ i ] ) \.{\geq} index}%
 \@x{\makebox[0pt][r]{\scriptsize 516\hspace{1em}}\@s{105.74} \.{\land} log [
 i ] [ index ] . term\@s{13.31} \.{\neq} m . mentries [ 1 ] . term}%
 \@x{\makebox[0pt][r]{\scriptsize 517\hspace{1em}}\@s{105.74} \.{\land}
 \.{\LET} new \.{\defeq} [ index2 \.{\in} 1 \.{\dotdot} ( Len ( log [ i ] )
 \.{-} 1 ) \.{\mapsto}}%
 \@x{\makebox[0pt][r]{\scriptsize 518\hspace{1em}}\@s{193.26} log [ i ] [
 index2 ] ]}%
 \@x{\makebox[0pt][r]{\scriptsize 519\hspace{1em}}\@s{116.85} \.{\IN} log
 \.{'} \.{=} [ log {\EXCEPT} {\bang} [ i ] \.{=} new ]}%
 \@x{\makebox[0pt][r]{\scriptsize 520\hspace{1em}}\@s{105.74} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, commitIndex ,\, messages {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 521\hspace{1em}}\@s{90.53} \.{\lor}}%
\@y{\@s{0}%
 no conflict: append entry
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 522\hspace{1em}}\@s{105.74} \.{\land} m .
 mentries \.{\neq} {\langle} {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 523\hspace{1em}}\@s{105.74} \.{\land} Len (
 log [ i ] ) \.{=} m . mprevLogIndex}%
 \@x{\makebox[0pt][r]{\scriptsize 524\hspace{1em}}\@s{105.74} \.{\land} log
 \.{'} \.{=} [ log {\EXCEPT} {\bang} [ i ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 525\hspace{1em}}\@s{161.05} Append ( log [ i
 ] ,\, m . mentries [ 1 ] ) ]}%
 \@x{\makebox[0pt][r]{\scriptsize 526\hspace{1em}}\@s{105.74} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, commitIndex ,\, messages {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 527\hspace{1em}}\@s{36.79} \.{\land}
 {\UNCHANGED} {\langle} candidateVars ,\, leaderVars ,\, witnessVars
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 529\hspace{1em}}}%
\@y{\@s{0}%
 Witness receives an \ensuremath{AppendEntriesToWitnessRequest} from server
 \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 530\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{\leq} currentTerm[WitnessID]}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 531\hspace{1em}}
 HandleAppendEntriesToWitnessRequest ( j ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 532\hspace{1em}}\@s{16.4} \.{\land} m .
 mterm \.{\leq} currentTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 533\hspace{1em}}\@s{16.4} \.{\land}
 \.{\lor}}%
\@y{\@s{0}%
 reject request
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 534\hspace{1em}}\@s{38.62} \.{\land} m .
 mterm \.{<} currentTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 535\hspace{1em}}\@s{38.62} \.{\land} Reply (
 [ mtype\@s{49.62} \.{\mapsto} AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 536\hspace{1em}}\@s{81.18} mterm\@s{46.67}
 \.{\mapsto} currentTerm [ WitnessID ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 537\hspace{1em}}\@s{81.18}
 msuccess\@s{36.52} \.{\mapsto} {\FALSE} ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 538\hspace{1em}}\@s{81.18}
 mmatchIndex\@s{16.40} \.{\mapsto} 0 ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 539\hspace{1em}}\@s{81.18} msource\@s{40.04}
 \.{\mapsto} WitnessID ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 540\hspace{1em}}\@s{81.18} mdest\@s{49.68}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 541\hspace{1em}}\@s{81.18} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 542\hspace{1em}}\@s{38.62} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, logVars ,\, witnessVars {\rangle}}%
\@x{\makebox[0pt][r]{\scriptsize 543\hspace{1em}}\@s{27.51} \.{\lor}}%
\@y{\@s{0}%
 accept request, always no conflict.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 544\hspace{1em}}\@s{38.62} \.{\land} m .
 mterm \.{=} currentTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 545\hspace{1em}}\@s{38.62} \.{\land}
 \.{\lor} m . mlastLogTerm \.{>} witnessLastLogTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 546\hspace{1em}}\@s{49.73} \.{\lor}
 \.{\land} m . mlastLogTerm \.{=} witnessLastLogTerm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 547\hspace{1em}}\@s{60.84} \.{\land} m .
 mlastLogSubterm \.{>} witnessLastLogSubterm [ WitnessID ]}%
 \@x{\makebox[0pt][r]{\scriptsize 548\hspace{1em}}\@s{38.62} \.{\land}
 witnessReplicationSet \.{'} \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 549\hspace{1em}}\@s{53.83} [
 witnessReplicationSet {\EXCEPT} {\bang} [ WitnessID ] \.{=} m .
 mreplicationSet ]}%
 \@x{\makebox[0pt][r]{\scriptsize 550\hspace{1em}}\@s{38.62} \.{\land}
 witnessLastLogTerm \.{'} \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 551\hspace{1em}}\@s{53.83} [
 witnessLastLogTerm {\EXCEPT} {\bang} [ WitnessID ] \.{=} m . mlastLogTerm ]}%
 \@x{\makebox[0pt][r]{\scriptsize 552\hspace{1em}}\@s{38.62} \.{\land}
 witnessLastLogSubterm \.{'} \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 553\hspace{1em}}\@s{53.83} [
 witnessLastLogSubterm {\EXCEPT} {\bang} [ WitnessID ] \.{=} m .
 mlastLogSubterm ]}%
\@x{\makebox[0pt][r]{\scriptsize 554\hspace{1em}}\@s{38.62}}%
\@y{\@s{0}%
 \ensuremath{log} will not be modified in real implementation. It is only
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 555\hspace{1em}}\@s{38.62}}%
\@y{\@s{0}%
 used here for the proof.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 556\hspace{1em}}\@s{38.62} \.{\land} log
 \.{'} \.{=} [ log {\EXCEPT} {\bang} [ WitnessID ] \.{=} m . mentries ]}%
 \@x{\makebox[0pt][r]{\scriptsize 557\hspace{1em}}\@s{38.62} \.{\land} Reply (
 [ mtype\@s{49.62} \.{\mapsto} AppendEntriesResponse ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 558\hspace{1em}}\@s{81.18} mterm\@s{46.67}
 \.{\mapsto} currentTerm [ WitnessID ] ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 559\hspace{1em}}\@s{81.18}
 msuccess\@s{36.52} \.{\mapsto} {\TRUE} ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 560\hspace{1em}}\@s{81.18}
 mmatchIndex\@s{16.40} \.{\mapsto} m . mindex ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 561\hspace{1em}}\@s{81.18} msource\@s{40.04}
 \.{\mapsto} WitnessID ,\,}%
 \@x{\makebox[0pt][r]{\scriptsize 562\hspace{1em}}\@s{81.18} mdest\@s{49.68}
 \.{\mapsto} j ] ,\,}%
\@x{\makebox[0pt][r]{\scriptsize 563\hspace{1em}}\@s{81.18} m )}%
 \@x{\makebox[0pt][r]{\scriptsize 564\hspace{1em}}\@s{38.62} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, log {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 565\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} candidateVars ,\, leaderVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 567\hspace{1em}}}%
\@y{\@s{0}%
 Server \ensuremath{i} receives an \ensuremath{AppendEntries} response from
 server \ensuremath{j} with
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 568\hspace{1em}}}%
\@y{\@s{0}%
 \ensuremath{m.mterm \.{=} currentTerm[i]}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 569\hspace{1em}} HandleAppendEntriesResponse
 ( i ,\, j ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 570\hspace{1em}}\@s{16.4} \.{\land} m .
 mterm \.{=} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 571\hspace{1em}}\@s{16.4} \.{\land} \.{\lor}
 \.{\land} m . msuccess}%
\@y{\@s{0}%
 successful
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 572\hspace{1em}}\@s{38.62} \.{\land}
 nextIndex \.{'}\@s{8.13} \.{=} [ nextIndex\@s{4.1} {\EXCEPT} {\bang} [ i ] [
 j ]\@s{4.03} \.{=} m . mmatchIndex \.{+} 1 ]}%
 \@x{\makebox[0pt][r]{\scriptsize 573\hspace{1em}}\@s{38.62} \.{\land}
 matchIndex \.{'} \.{=} [ matchIndex {\EXCEPT} {\bang} [ i ] [ j ] \.{=} m .
 mmatchIndex ]}%
 \@x{\makebox[0pt][r]{\scriptsize 574\hspace{1em}}\@s{27.51} \.{\lor}
 \.{\land} {\lnot} m . msuccess}%
\@y{\@s{0}%
 not successful
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 575\hspace{1em}}\@s{38.62} \.{\land}
 nextIndex \.{'} \.{=} [ nextIndex {\EXCEPT} {\bang} [ i ] [ j ] \.{=}}%
 \@x{\makebox[0pt][r]{\scriptsize 576\hspace{1em}}\@s{128.26} Max ( \{
 nextIndex [ i ] [ j ] \.{-} 1 ,\, 1 \} ) ]}%
 \@x{\makebox[0pt][r]{\scriptsize 577\hspace{1em}}\@s{38.62} \.{\land}
 {\UNCHANGED} {\langle} matchIndex {\rangle}}%
 \@x{\makebox[0pt][r]{\scriptsize 578\hspace{1em}}\@s{16.4} \.{\land} Discard
 ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 579\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, logVars ,\,
 elections ,\, witnessVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 581\hspace{1em}}}%
\@y{\@s{0}%
 Any \ensuremath{RPC} with a newer term causes the recipient to advance its
 term first.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 582\hspace{1em}} UpdateTerm ( i ,\, j ,\, m
 ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 583\hspace{1em}}\@s{16.4} \.{\land} m .
 mterm \.{>} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 584\hspace{1em}}\@s{16.4} \.{\land}
 currentTerm \.{'}\@s{12.29} \.{=} [ currentTerm {\EXCEPT} {\bang} [ i ]
 \.{=} m . mterm ]}%
 \@x{\makebox[0pt][r]{\scriptsize 585\hspace{1em}}\@s{16.4} \.{\land} state
 \.{'}\@s{46.68} \.{=} [ state\@s{24.59} {\EXCEPT} {\bang} [ i ]\@s{9.78}
 \.{=} Follower ]}%
 \@x{\makebox[0pt][r]{\scriptsize 586\hspace{1em}}\@s{16.4} \.{\land} votedFor
 \.{'}\@s{29.48} \.{=} [ votedFor\@s{12.29} {\EXCEPT} {\bang} [ i ]\@s{4.88}
 \.{=} Nil ]}%
\@x{\makebox[0pt][r]{\scriptsize 587\hspace{1em}}\@s{27.51}}%
\@y{\@s{0}%
 messages is unchanged so \ensuremath{m} can be processed further.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 588\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} messages ,\, candidateVars ,\, leaderVars ,\, logVars
 {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 590\hspace{1em}}}%
\@y{\@s{0}%
 Responses with stale terms are ignored.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 591\hspace{1em}} DropStaleResponse ( i ,\, j
 ,\, m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 592\hspace{1em}}\@s{16.4} \.{\land} m .
 mterm \.{<} currentTerm [ i ]}%
 \@x{\makebox[0pt][r]{\scriptsize 593\hspace{1em}}\@s{16.4} \.{\land} Discard
 ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 594\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 596\hspace{1em}}}%
\@y{\@s{0}%
 Receive a message.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 597\hspace{1em}} Receive ( m ) \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 598\hspace{1em}}\@s{16.4} \.{\LET}
 i\@s{0.42} \.{\defeq} m . mdest}%
 \@x{\makebox[0pt][r]{\scriptsize 599\hspace{1em}}\@s{36.79} j \.{\defeq} m .
 msource}%
\@x{\makebox[0pt][r]{\scriptsize 600\hspace{1em}}\@s{16.4} \.{\IN}}%
\@y{\@s{0}%
 Any \ensuremath{RPC} with a newer term causes the recipient to advance
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 601\hspace{1em}}\@s{36.79}}%
\@y{\@s{0}%
 its term first. Responses with stale terms are ignored.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 602\hspace{1em}}\@s{36.79} \.{\lor}
 UpdateTerm ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 603\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} RequestVoteRequest}%
 \@x{\makebox[0pt][r]{\scriptsize 604\hspace{1em}}\@s{47.91} \.{\land}
 HandleRequestVoteRequest ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 605\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} RequestWitnessVoteRequest}%
 \@x{\makebox[0pt][r]{\scriptsize 606\hspace{1em}}\@s{47.91} \.{\land}
 HandleRequestWitnessVoteRequest ( j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 607\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} RequestVoteResponse}%
 \@x{\makebox[0pt][r]{\scriptsize 608\hspace{1em}}\@s{47.91} \.{\land}
 \.{\lor} DropStaleResponse ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 609\hspace{1em}}\@s{59.02} \.{\lor}
 HandleRequestVoteResponse ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 610\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} AppendEntriesRequest}%
 \@x{\makebox[0pt][r]{\scriptsize 611\hspace{1em}}\@s{47.91} \.{\land}
 HandleAppendEntriesRequest ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 612\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} AppendEntriesToWitnessReques}%
 \@x{\makebox[0pt][r]{\scriptsize 613\hspace{1em}}\@s{47.91} \.{\land}
 HandleAppendEntriesToWitnessRequest ( j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 614\hspace{1em}}\@s{36.79} \.{\lor}
 \.{\land} m . mtype \.{=} AppendEntriesResponse}%
 \@x{\makebox[0pt][r]{\scriptsize 615\hspace{1em}}\@s{47.91} \.{\land}
 \.{\lor} DropStaleResponse ( i ,\, j ,\, m )}%
 \@x{\makebox[0pt][r]{\scriptsize 616\hspace{1em}}\@s{59.02} \.{\lor}
 HandleAppendEntriesResponse ( i ,\, j ,\, m )}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 618\hspace{1em}}}%
\@y{\@s{0}%
 End of message handlers.
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 619\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 620\hspace{1em}}}%
\@y{\@s{0}%
 Network state transitions
}%
\@xx{}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 622\hspace{1em}}}%
\@y{\@s{0}%
 The network duplicates a message
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 623\hspace{1em}} DuplicateMessage ( m )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 624\hspace{1em}}\@s{16.4} \.{\land} Send ( m
 )}%
 \@x{\makebox[0pt][r]{\scriptsize 625\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 627\hspace{1em}}}%
\@y{\@s{0}%
 The network drops a message
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 628\hspace{1em}} DropMessage ( m )
 \.{\defeq}}%
 \@x{\makebox[0pt][r]{\scriptsize 629\hspace{1em}}\@s{16.4} \.{\land} Discard
 ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 630\hspace{1em}}\@s{16.4} \.{\land}
 {\UNCHANGED} {\langle} serverVars ,\, candidateVars ,\, leaderVars ,\,
 logVars {\rangle}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 632\hspace{1em}}}\midbar\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 633\hspace{1em}}}%
\@y{\@s{0}%
 Defines how the variables may transition.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 634\hspace{1em}} Next \.{\defeq} \.{\land}
 \.{\lor} \E\, i \.{\in} Server \.{:} Restart ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 635\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 \.{\in} Server \.{:} Timeout ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 636\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 ,\, j \.{\in} Server \.{:} RequestVote ( i ,\, j )}%
 \@x{\makebox[0pt][r]{\scriptsize 637\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 \.{\in} Server \.{:} BecomeLeader ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 638\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 \.{\in} Server ,\, v \.{\in} Value \.{:} ClientRequest ( i ,\, v )}%
 \@x{\makebox[0pt][r]{\scriptsize 639\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 \.{\in} Server \.{:} AdvanceCommitIndex ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 640\hspace{1em}}\@s{50.94} \.{\lor} \E\, i
 ,\, j \.{\in} Server \.{:} AppendEntries ( i ,\, j )}%
 \@x{\makebox[0pt][r]{\scriptsize 641\hspace{1em}}\@s{50.94} \.{\lor} \E\,
 i\@s{4.85} \.{\in} Server \.{:} AdjustReplicationSet ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 642\hspace{1em}}\@s{50.94} \.{\lor} \E\,
 i\@s{4.85} \.{\in} Server \.{:} RequestWitnessVote ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 643\hspace{1em}}\@s{50.94} \.{\lor} \E\,
 i\@s{4.85} \.{\in} Server \.{:} AppendEntriesToWitness ( i )}%
 \@x{\makebox[0pt][r]{\scriptsize 644\hspace{1em}}\@s{50.94} \.{\lor} \E\, m
 \.{\in} {\DOMAIN} messages \.{:} Receive ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 645\hspace{1em}}\@s{50.94} \.{\lor} \E\, m
 \.{\in} {\DOMAIN} messages \.{:} DuplicateMessage ( m )}%
 \@x{\makebox[0pt][r]{\scriptsize 646\hspace{1em}}\@s{50.94} \.{\lor} \E\, m
 \.{\in} {\DOMAIN} messages \.{:} DropMessage ( m )}%
\@x{\makebox[0pt][r]{\scriptsize 647\hspace{1em}}\@s{50.94}}%
\@y{\@s{0}%
 History variable that tracks every \ensuremath{log} ever:
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 648\hspace{1em}}\@s{39.83} \.{\land} allLogs
 \.{'} \.{=} allLogs \.{\cup} \{ log [ i ] \.{:} i \.{\in} Server \}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 650\hspace{1em}}}%
\@y{\@s{0}%
 The specification must start with the initial state and transition according
}%
\@xx{}%
\@x{\makebox[0pt][r]{\scriptsize 651\hspace{1em}}}%
\@y{\@s{0}%
 to \ensuremath{Next}.
}%
\@xx{}%
 \@x{\makebox[0pt][r]{\scriptsize 652\hspace{1em}} Spec \.{\defeq} Init
 \.{\land} {\Box} [ Next ]_{ vars}}%
\@pvspace{8.0pt}%
\@x{\makebox[0pt][r]{\scriptsize 654\hspace{1em}}}\bottombar\@xx{}%
\@pvspace{8.0pt}%
